<!-- Hero Section -->
<div class="hero-section">
  <div class="hero-content">
    <h1 class="hero-title">{{ isAdmin ? 'All Orders' : 'My Orders' }}</h1>
    <p class="hero-subtitle">{{ isAdmin ? 'Manage and track all customer orders' : 'View and track your order history' }}</p>
  </div>
</div>

<div class="container">
  <!-- Loading State -->
  <div class="loading" *ngIf="loading">
    <p>Loading orders...</p>
  </div>

  <!-- Error State -->
  <div class="error-message" *ngIf="error">
    <p>{{ error }}</p>
  </div>

  <!-- Empty State -->
  <div class="orders-empty" *ngIf="!loading && !error && groupedOrders.length === 0">
    <h2>{{ isAdmin ? 'No orders found' : 'No orders yet' }}</h2>
    <p>{{ isAdmin ? 'No customers have placed orders yet.' : 'Start shopping to see your orders here!' }}</p>
    <button class="btn btn-primary" routerLink="/product">Browse Products</button>
  </div>

  <!-- Orders List -->
  <div class="orders-list" *ngIf="!loading && !error && groupedOrders.length > 0">
    <div class="order-card" *ngFor="let order of groupedOrders">
      <!-- Order Header -->
      <div class="order-header">
        <div class="order-info">
          <h3>Order #{{ order.orderId }}</h3>
          <p class="order-date">{{ formatDate(order.created) }}</p>
          <p class="customer-name">Customer: {{ order.customerName }}</p>
        </div>
        <div class="order-status">
          <span class="status-badge" [ngClass]="getStatusClass(order.items[0].orderStatus, order.items[0].status)">
            {{ getStatusBadge(order.items[0].orderStatus, order.items[0].status) }}
          </span>
          <p class="order-total">₱{{ order.total.toFixed(2) }}</p>
        </div>
      </div>

      <!-- Order Items -->
      <div class="order-items">
        <div class="order-item" *ngFor="let item of order.items">
          <img [src]="getProductImage(item.productImageFile)" 
               [alt]="item.productName" 
               class="item-image">
          <div class="item-details">
            <h4>{{ item.productName }}</h4>
            <p class="item-category">{{ item.productCategoryName }}</p>
            <p class="item-description">{{ item.productDescription }}</p>
          </div>
          <div class="item-quantity">
            <p>Qty: {{ item.quantity }}</p>
          </div>
          <div class="item-price">
            <p>₱{{ item.price.toFixed(2) }}</p>
            <p class="item-total">₱{{ (item.price * item.quantity).toFixed(2) }}</p>
          </div>
        </div>
      </div>

      <!-- Order Footer -->
      <div class="order-footer">
        <div class="order-summary">
          <div class="summary-row">
            <span>Items:</span>
            <span>{{ order.items.length }}</span>
          </div>
          <div class="summary-row">
            <span>Subtotal:</span>
            <span>₱{{ (order.total / 1.08).toFixed(2) }}</span>
          </div>
          <div class="summary-row">
            <span>Tax (8%):</span>
            <span>₱{{ (order.total - (order.total / 1.08)).toFixed(2) }}</span>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span>₱{{ order.total.toFixed(2) }}</span>
          </div>
        </div>
        
        <!-- Admin Controls -->
        <div class="admin-controls" *ngIf="isAdmin && order.items[0].orderStatus === 'PENDING'">
          <h4>Admin Actions:</h4>
          <div class="admin-buttons">
            <button class="btn btn-success" (click)="acceptOrder(order.items[0].id!)">
              Accept 
            </button>
            <button class="btn btn-danger" (click)="rejectOrder(order.items[0].id!)">
              Reject
            </button>
            <button class="btn btn-info" (click)="processOrder(order.items[0].id!)">
              Processing
            </button>
          </div>
        </div>
        
        <!-- Admin Notes Display - Visible to BOTH Admin and Customer -->
        <div class="admin-notes" *ngIf="order.items[0].adminNotes">
          <h4>Admin Notes:</h4>
          <p>{{ order.items[0].adminNotes }}</p>
        </div>

        <!-- Customer Notes Section -->
        <div class="customer-notes-section">
          <h4>{{ isAdmin ? 'Customer Message' : 'Your Message to Admin' }}</h4>
          
          <!-- Show existing customer notes (read-only) -->
          <div *ngIf="order.items[0].customerNotes && editingCustomerNotes !== order.orderId" class="customer-notes-display">
            <p>{{ order.items[0].customerNotes }}</p>
            <button 
              *ngIf="!isAdmin" 
              class="btn btn-edit" 
              (click)="startEditingCustomerNotes(order)">
              Edit Message
            </button>
          </div>

          <!-- Edit/Add customer notes (for customers only) -->
          <div *ngIf="!isAdmin && (!order.items[0].customerNotes || editingCustomerNotes === order.orderId)" class="customer-notes-edit">
            <textarea 
              [(ngModel)]="customerNotes" 
              class="notes-textarea"
              placeholder="Have a question about this order? Ask the admin here..."
              rows="3">
            </textarea>
            <div class="notes-actions">
              <button class="btn btn-primary" (click)="saveCustomerNotes(order)">
                {{ order.items[0].customerNotes ? 'Update Message' : 'Send Message' }}
              </button>
              <button 
                *ngIf="order.items[0].customerNotes" 
                class="btn btn-secondary" 
                (click)="cancelEditingCustomerNotes()">
                Cancel
              </button>
            </div>
          </div>

          <!-- No notes yet (read-only for admin) -->
          <p *ngIf="isAdmin && !order.items[0].customerNotes" class="no-notes">
            Customer hasn't sent a message yet.
          </p>

          <!-- Admin Reply Button (only if customer sent a message) -->
          <button 
            *ngIf="isAdmin && order.items[0].customerNotes" 
            class="btn btn-reply" 
            (click)="replyToCustomer(order)">
            {{ order.items[0].adminNotes ? 'Update Reply' : 'Reply to Customer' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Admin Notes Dialog Modal -->
<div class="modal-overlay" *ngIf="showNotesDialog" (click)="closeNotesDialog()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ currentAction === '' ? 'Reply to Customer' : 'localhost:4200 says' }}</h3>
    </div>
    <div class="modal-body">
      <label for="adminNotes">
        {{ currentAction === '' ? 'Your reply to customer:' : 'Add admin notes ' + (currentAction === 'REJECTED' ? '(required for rejection)' : '(optional)') + ':' }}
      </label>
      <textarea 
        id="adminNotes" 
        [(ngModel)]="adminNotes" 
        class="notes-input"
        placeholder="Enter your notes here..."
        rows="4"
        [autofocus]="true">
      </textarea>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" (click)="closeNotesDialog()">Cancel</button>
      <button class="modal-btn modal-btn-primary" (click)="submitAdminNotes()">OK</button>
    </div>
  </div>
</div>
